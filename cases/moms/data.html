<!DOCTYPE HTML>
<html lang="en-US" manifest="../../manifest.appcache">
    
    <head>
        
        <meta charset="UTF-8">
        <title>Data | Virkdata Open Data School</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 0.5.6">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    <meta name="author" content="virkdata">
    
    
    <link rel="next" href="../../cases/moms/kort.html" />
    
    
    <link rel="prev" href="../../cases/moms/README.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../../gitbook/style.css">

    
    <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-richquotes/plugin.css">
    


        
    <div class="book" data-github="virkdata/opendataschool" data-level="2.1" data-basepath="../.." data-revision="1421320532628">
    <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    <span id="font-settings-wrapper">
        <a href="#" class="btn pull-left toggle-font-settings" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="btn-group btn-block">
        <button id="reduce-font-size" class="btn btn-default">A</button>
        <button id="enlarge-font-size" class="btn btn-default">A</button>
    </div>

    <ul class="list-group font-family-list">
        <li class="list-group-item" data-font="0">Serif</li>
        <li class="list-group-item" data-font="1">Sans</li>
    </ul>

    <div class="btn-group btn-group-xs btn-block color-theme-list">
        <button type="button" class="btn btn-default" id="color-theme-preview-0" data-theme="0">White</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-1" data-theme="1">Sepia</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-2" data-theme="2">Night</button>
    </div>
</div>

    </span>

    <!-- Actions Right -->
    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    

    
    <a href="https://github.com/virkdata/opendataschool/stargazers" target="_blank" class="btn pull-right count-star hidden-xs"><i class="fa fa-star-o"></i> Star (<span>-</span>)</a>
    <a href="https://github.com/virkdata/opendataschool/watchers" target="_blank" class="btn pull-right count-watch hidden-xs"><i class="fa fa-eye"></i> Watch (<span>-</span>)</a>
    

    <!-- Title -->
    <h1>
        <i class="fa fa-spinner fa-spin"></i>
        <a href="../../" >Virkdata Open Data School</a>
    </h1>
</div>

    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Search" class="form-control" />
    </div>
    <ul class="summary">
        
        
        
        <li>
            <a href="https://github.com/virkdata" target="blank" class="author-link">About the author</a>
        </li>
        

        
        
        <li>
            <a href="https://github.com/virkdata/opendataschool/issues" target="blank"class="issues-link">Questions and Issues</a>
        </li>
        

        
        
        <li>
            <a href="https://github.com/virkdata/opendataschool/edit/master/cases/moms/data.md" target="blank" class="contribute-link">Edit and Contribute</a>
        </li>
        

        
        <li class="divider"></li>
        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduktion
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="data/README.html">
            
                
                    <a href="../../data/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         Data
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.1" data-path="data/moms.html">
            
                
                    <a href="../../data/moms.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                         Moms
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2" data-path="data/dagi.html">
            
                
                    <a href="../../data/dagi.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                         Administrative grænser
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="cases/moms/README.html">
            
                
                    <a href="../../cases/moms/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         Case: Momskortet
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="2.1" data-path="cases/moms/data.html">
            
                
                    <a href="../../cases/moms/data.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                         Data
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.2" data-path="cases/moms/kort.html">
            
                
                    <a href="../../cases/moms/kort.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                         kort
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="visualisering/README.html">
            
                
                    <a href="../../visualisering/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         Visualisering
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Generated using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="page-wrapper" tabindex="-1">
                <div class="book-progress">
    <div class="bar">
        <div class="inner" style="width: 71.42857142857143%;min-width: 57.142857142857146%;"></div>
    </div>
    <div class="chapters">
    
        <a href="../../index.html" title="Introduktion" class="chapter done new-chapter" data-progress="0" style="left: 0%;"></a>
    
        <a href="../../data/README.html" title="Data" class="chapter done new-chapter" data-progress="1" style="left: 14.285714285714286%;"></a>
    
        <a href="../../data/moms.html" title="Moms" class="chapter done " data-progress="1.1" style="left: 28.571428571428573%;"></a>
    
        <a href="../../data/dagi.html" title="Administrative grænser" class="chapter done " data-progress="1.2" style="left: 42.857142857142854%;"></a>
    
        <a href="../../cases/moms/README.html" title="Case: Momskortet" class="chapter done new-chapter" data-progress="2" style="left: 57.142857142857146%;"></a>
    
        <a href="../../cases/moms/data.html" title="Data" class="chapter done " data-progress="2.1" style="left: 71.42857142857143%;"></a>
    
        <a href="../../cases/moms/kort.html" title="kort" class="chapter  " data-progress="2.2" style="left: 85.71428571428571%;"></a>
    
        <a href="../../visualisering/README.html" title="Visualisering" class="chapter  new-chapter" data-progress="3" style="left: 100%;"></a>
    
    </div>
</div>

                <div class="page-inner">
                
                    <section class="normal" id="section-gitbook_3">
                    
                        <h2 id="data-til-momskortet">Data til momskortet</h2>
<p>Til denne case anvendes dels data fra SKAT for momsomsætning fordelt på virksomheder og dels de kommunale administrative grænser fra Geodatastyrelsen. Se afsnit om <a href="/../data/README.html">data</a></p>
<h1 id="cartodb">CartoDB</h1>
<p>I denne CASE bruger vi CartoDB som er baseret på en <a href="http://www.postgresql.org/" target="_blank">PostgreSQL</a> database med funktionalitet til geografiske data og analyser med udvidelsen <a href="http://postgis.net/" target="_blank">PostGIS</a>. Når data er indlæst i CartoDB, kan vi dermed bruge SQL til at udforske vores datasæt samt manipulere vores data i databasen. CartoDB er udstyret en SQL editor direkte i webbrowseren så vi let kan udforske og klargøre vores indlæste data. Lær mere om <a href="http://www.w3schools.com/sql/" target="_blank">SQL</a>. Lær mere om geografiske analyser med PostGIS i CartoDB<a href="http://docs.cartodb.com/tips-and-tricks.html#geospatial-analysis" target="_blank">http://docs.cartodb.com/tips-and-tricks.html#geospatial-analysis</a></p>
<p>I denne CASE udnytter vi SQL funktioner fra både PostgreSQL og PostGIS til dels  at klargøre vores indlæste data og dels til at <a href="http://www.postgresql.org/docs/9.3/static/tutorial-join.html" target="_blank">JOINE</a> vores to datasæt.</p>
<h2 id="upload-moms-data-til-cartodb">Upload moms-data til CartoDB</h2>
<ol>
<li>Opret en konto hos <a href="https://cartodb.com/" target="_blank">CartoDB</a>
2.Klik &quot;view your tables&quot;</li>
<li>Klik &quot;New table&quot; og vælg filen fra <a href="/../data/moms.html">Moms-data</a></li>
<li>Når filen er uploaded klikkes på kolonne navnene og de omdøbes så vi har en kolonne for: komnavn,branche og omsaetning</li>
</ol>
<iframe width="560" height="315" src="//www.youtube.com/embed/glX4yp_ETQQ" frameborder="0" allowfullscreen=""></iframe>



<h3 id="upload-kommunegr-nser-til-cartodb">Upload kommunegrænser til CartoDB</h3>
<ol>
<li>Klik &quot;view your tables&quot;</li>
<li>Udpak filen og vælg alle filerne med navnet KOMMUNE.* og pak dem i en nye .zip fil</li>
<li>Klik &quot;New table&quot; og vælg filen fra <a href="/../data/dagi.html">DAGI-data</a></li>
<li>Upload denne nye zip fil med kommunegrænser til CartoDB</li>
</ol>
<iframe width="560" height="315" src="//www.youtube.com/embed/aGrRyiSol1I" frameborder="0" allowfullscreen=""></iframe>



<h2 id="klarg-ring-af-data">Klargøring af data</h2>
<p>Førend de to datasæt kan forenes (joines) korrekt, er det nødvendigt at de deler en fælles nøgle. I denne case skal data joines på kommune. DAGI-datasættet med kommunegrænser indeholder en kolonne for kommunekoden og en kolonne for kommunenavnet mens moms-datasættet alene indeholder en kolonne for kommunenavn. Derfor er vi nødsaget til at bruge kolonnen for kommunenavn til vores data-join. Derudover bruges ikke nøjagtigt samme kommunenavne i de to datasæt. Vi vil derfor forsøge at manipulere data således der er to kolonner med samme stavemåde på kommunenavne. Desuden har vi en udfordring med antallet af kommunepolygoner i DAGI-datasættet. Lad os starte med den</p>
<blockquote class="clearfix alert alert-warning"><strong class="fa fa-4x fa-exclamation-triangle"></strong>
<p>
Det er ikke optimalt at joine på et tekstfelt. En kolonne med kommunekode bestående af heltal vil være meget bedre at anvende til at joine de to datasæt.</p>
</blockquote>
<h4 id="kommunegr-nser">Kommunegrænser</h4>
<p>Hvis vi hurtigt inspicerer vores datasæt for kommunerne, kan vi se at der er langt flere rækkker end der er kommuner i Danmark. Det skyldes måden datasættet er konstrueret på. Geometritypen i datasættet er defineret som en POLYGON og ikke en MULTIPOLYGON. Det bevirker at polygoner, der ikke hører sammen geometrisk har en selvstændig række i datasættet. Til en kommune kan der oftes knyttes flere enkelt polygoner. F.eks. har Amager en selvstændig polygon, som ikke hører til Indre København. Det giver problemer når vi skal joine til moms-datasættet. Vi kan med SQL lægge kommunepolygonerne sammen for de rækker, der hører til samme kommune.</p>
<p>Hvis vi tæller antallet af rækker, kan vi hurtigt se at der er flere (311) rækker end de 99 kommuner.</p>
<pre><code class="lang-sql"><span class="hljs-operator"><span class="hljs-keyword">SELECT</span> <span class="hljs-aggregate">COUNT</span>(*) <span class="hljs-keyword">FROM</span> kommune</span>
</code></pre>
<blockquote class="clearfix alert alert-info"><strong class="fa fa-4x fa-comment-o"></strong>
<p>
<a href="http://www.postgresql.org/docs/9.3/static/functions-aggregate.html" target="_blank">COUNT</a> er en AGGREGATE funktion i SQL, der bla. kan bruges til at lave simple statistikker på datasættet. Vi anvender SQL <a href="http://www.postgresql.org/docs/9.3/static/sql-select.html" target="_blank">SELECT</a> som kun udvælger i data. Vi retter IKKE i datasættet med SELECT.</p>
</blockquote>
<p>Vi bruger en særlig <a href="http://postgis.refractions.net/documentation/" target="_blank">POSTGIS</a> funktion <a href="http://postgis.net/docs/manual-2.0/ST_Union.html" target="_blank">ST_UNION</a> til at lægge polygoner for samme kommune sammen.</p>
<pre><code class="lang-sql"><span class="hljs-operator"><span class="hljs-keyword">SELECT</span> st_union(the_geom) <span class="hljs-keyword">as</span> the_geom, komnavn <span class="hljs-keyword">FROM</span> kommune <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">by</span> komnavn</span>
</code></pre>
<p>Klik på linket &quot;create table from query&quot; og navngiv den nye tabel kommune_union</p>
<blockquote class="clearfix alert alert-info"><strong class="fa fa-4x fa-comment-o"></strong>
<p>
Når man anvender GROUP BY i SQL, lægger man rækker sammen. Derfor skal øvrige kolonner aggregeres. Her lægges geomtrierne sammen med en aggregate funktion, som hedder ST_Union() for alle de rækker med samme kommunenavn.</p>
</blockquote>
<h4 id="kommunenavne">Kommunenavne</h4>
<p>Da CartoDB er baseret på <a href="http://da.wikipedia.org/wiki/Structured_Query_Language" target="_blank">SQL</a>, vil vi manipulere data med SQL statements. Vi vil oprette en ny kolonne i vores datasæt for kommunegrænser som stemmer overnes med dén navngivning af kommunerne, der findes i moms-datasættet.</p>
<ol>
<li>Klik på SQL fanen i tabelvisningen af kommunegrænser</li>
<li>Opret ny kolonne med følgende SQL</li>
</ol>
<pre><code class="lang-sql"><span class="hljs-operator"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> kommune_union <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">column</span> komnavn_moms <span class="hljs-keyword">character</span> <span class="hljs-keyword">varying</span></span>
</code></pre>
<p>Opdatér kolonnen med de eksisterende kommunenavne og endelsen &quot;Kommune&quot;. Vi starter med at tilføjde denne endelse i vores nye kolonne.</p>
<pre><code class="lang-sql"><span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> kommune_union <span class="hljs-keyword">SET</span> komnavn_moms = komnavn || <span class="hljs-string">' Kommune'</span></span>
</code></pre>
<p>Vi kan nu lave et JOIN for at set om alle vores rækker i vores redigerede kommune-tabel kan JOINES på moms-datasættet</p>
<p>Vi bruger LEFT JOIN så vi sikrer os at vi får alle rækker fra kommunegrænserne og kan se, hvor det ikke har været muligt at joine de to datasæt</p>
<pre><code class="lang-sql"><span class="hljs-operator"><span class="hljs-keyword">SELECT</span> kom.the_geom,
kom.komnavn_moms,
skat.komnavn,
skat.omsaetning,
skat.branche
<span class="hljs-keyword">FROM</span> kommune_union kom
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> skat_momsomsaetning_2012 skat <span class="hljs-keyword">ON</span> (kom.komnavn_moms=skat.komnavn
  <span class="hljs-keyword">AND</span> skat.branche=<span class="hljs-string">'Murere'</span>)
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> kom.komnavn_moms</span>
</code></pre>
<p>Vi kan se, at der er en række kolonner fra moms-tabellen (komnavn,omsaetning,brancnhe), der har null-værdier. Det skyldes, at databasen ikke har kunne JOINE felterne og de altså ikke er ens (endnu). Det første, der springer i øjnene er at Århus staves med Aa i DAGI-datasættet mens det staves med Å i moms-datasættet. Lad os rette vores kommune-tabel de steder, hvor stavemåden stadig er forskellig.</p>
<pre><code class="lang-sql"><span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> kommune_union <span class="hljs-keyword">SET</span> komnavn_moms = <span class="hljs-string">'Århus Kommune'</span> <span class="hljs-keyword">WHERE</span> komnavn_moms = <span class="hljs-string">'Aarhus Kommune'</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> kommune_union <span class="hljs-keyword">SET</span> komnavn_moms = <span class="hljs-string">'Brønderslev-Dronninglund Kommune'</span> <span class="hljs-keyword">WHERE</span> komnavn_moms = <span class="hljs-string">'Brønderslev Kommune'</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> kommune_union <span class="hljs-keyword">SET</span> komnavn_moms = <span class="hljs-string">'Høje-Taastrup Kommune'</span> <span class="hljs-keyword">WHERE</span> komnavn_moms = <span class="hljs-string">'Høje Taastrup Kommune'</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> kommune_union <span class="hljs-keyword">SET</span> komnavn_moms = <span class="hljs-string">'Københavns Kommune'</span> <span class="hljs-keyword">WHERE</span> komnavn_moms = <span class="hljs-string">'København Kommune</span></span>
</code></pre>
<p>Når vi afvikler ovenstående JOIN kan vi se, at der stadig er rækker der ikke JOINEs fordi ordet &quot;Kommune&quot; i nogle rækker er stavet med lille &quot;k&quot;. Vi opdaterer moms-datasætte og sikrer at Kommune er stavet med Stort &quot;M&quot;</p>
<pre><code class="lang-sql"><span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> skat_momsomsaetning_2012 <span class="hljs-keyword">set</span> komnavn = <span class="hljs-keyword">replace</span>(komnavn, <span class="hljs-string">'kommune'</span>, <span class="hljs-string">'Kommune'</span>)</span>
</code></pre>
<p>Der er stadig udfordringer. Christiansø er ikke en kommunal administrativ inddeling og findes ikke i moms-datasættet. Vil vælger at slette denne i vores kommunegrænser.</p>
<pre><code class="lang-sql"><span class="hljs-operator"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> kommune_union <span class="hljs-keyword">WHERE</span> komnavn_moms = <span class="hljs-string">'Christiansø Kommune'</span></span>
</code></pre>
<p>Endelig kan vi se at den eneste ikke kommune der ikke kan joines, er Norddjurs Kommune. Den findes ikke i moms-datasættet. Det kan skyldes muligvis, at der er mindre en fem virksomheder af den type i kommunen. Disse medtages ikke kan man se på <a href="http://datahub.virk.dk/dataset/momsomsaetning-gennemsnit" target="_blank">Virk Data</a></p>
<iframe width="560" height="315" src="//www.youtube.com/embed/kFr_rBbzWF0" frameborder="0" allowfullscreen=""></iframe>


<p>Vi er nu klar til at producere selve kortet</p>

                    
                    </section>
                
                </div>
            </div>
        </div>

        
        <a href="../../cases/moms/README.html" class="navigation navigation-prev " aria-label="Previous page: Case: Momskortet"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../cases/moms/kort.html" class="navigation navigation-next " aria-label="Next page: kort"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/jsrepl/jsrepl.js" id="jsrepl-script"></script>
<script src="../../gitbook/app.js"></script>

    
    <script src="http://cdn.mathjax.org/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
